//MissionInfo.cs
//Phantom139

//Weapon Stuff
$WeaponDetails[0, "name"] = "Ryder Pistol";
$WeaponDetails[0, "lock"] = ".... You've got some issues bud.";
$WeaponDetails[0, "descript"] = "Standard issue combat pistol for ground forces, however after the initial zombie uprising, civilian forces have been spotted with these weapons. The quick fire and reload clip system makes the ryder the ideal hit and run weapon for any combat situation.";
$WeaponDetails[0, "clipSize"] = 8;
$WeaponDetails[0, "capacity"] = 15;
$WeaponDetails[0, "damage"] = 15 / 100;
$WeaponDetails[0, "accuracy"] = 60 / 100;
$WeaponDetails[0, "fireRate"] = 75 / 100;
$WeaponDetails[0, "reloadSpeed"] = 80 / 100;
$WeaponDetails[0, "guiInfo"] = "Armory_RyderImage\tRyderButton";

$WeaponDetails[1, "name"] = "Duke Pistol";
$WeaponDetails[1, "lock"] = "Complete 'Ryder Apprentice' to Unlock.";
$WeaponDetails[1, "descript"] = "A heavier pistol brought into service after the initial zombie uprising, the Duke packs a powerful punch in the form of a 30mm round which is capable of blasting zombies into bits rather quickly, the weight of the munitions as well as the weapon itself make it much less versatile than it's counterpart, the Ryder.";
$WeaponDetails[1, "clipSize"] = 4;
$WeaponDetails[1, "capacity"] = 8;
$WeaponDetails[1, "damage"] = 70 / 100;
$WeaponDetails[1, "accuracy"] = 50 / 100;
$WeaponDetails[1, "fireRate"] = 30 / 100;
$WeaponDetails[1, "reloadSpeed"] = 45 / 100;
$WeaponDetails[1, "guiInfo"] = "Armory_DukeImage\tDukeButton";

$WeaponDetails[2, "name"] = "Lurker Assault Rifle";
$WeaponDetails[2, "lock"] = "Complete 'Ryder Marksman I' to Unlock.";
$WeaponDetails[2, "descript"] = "The lurker is the only remaining assault rifle after many years of fighting, yet it's basic design and effectiveness keep it in service, the Lurker is a high rate of fire automatic weapon that although lacks in terms of firepower, can deliver the kills quickly with it's firing speed.";
$WeaponDetails[2, "clipSize"] = 30;
$WeaponDetails[2, "capacity"] = 7;
$WeaponDetails[2, "damage"] = 20 / 100;
$WeaponDetails[2, "accuracy"] = 55 / 100;
$WeaponDetails[2, "fireRate"] = 90 / 100;
$WeaponDetails[2, "reloadSpeed"] = 60 / 100;
$WeaponDetails[2, "guiInfo"] = "Armory_LurkerImage\tLurkerButton";

$WeaponDetails[3, "name"] = "Disposition Shotgun";
$WeaponDetails[3, "lock"] = "Complete 'Ryder Apprentice' and 'Lurker Apprentice' to Unlock.";
$WeaponDetails[3, "descript"] = "When the zombies first came about, common sense drove many to seek their trusty twelve-gauge shotgun to handle the situation. Even to this date, the Disposition Shotgun still remains a very effective close quarters weapon capable of taking down zombies quickly.";
$WeaponDetails[3, "clipSize"] = 8;
$WeaponDetails[3, "capacity"] = 5;
$WeaponDetails[3, "damage"] = 85 / 100;
$WeaponDetails[3, "accuracy"] = 30 / 100;
$WeaponDetails[3, "fireRate"] = 30 / 100;
$WeaponDetails[3, "reloadSpeed"] = 45 / 100;
$WeaponDetails[3, "guiInfo"] = "Armory_DispositionImage\tDispositionButton";

$WeaponDetails[4, "name"] = "Swarmer";
$WeaponDetails[4, "lock"] = "Complete 'Disposition Mastery' to Unlock.";
$WeaponDetails[4, "descript"] = "Crude in most forms, the Swarmer is a less common weapon found in field. The origins of this grenade launching weapon are unknown, yet it is a prefered weapon because of it's anti-hoard burst fire feature, which allows it to launch all three loaded grenades at once allowing for quite a cluster strike of explosions.";
$WeaponDetails[4, "clipSize"] = 3;
$WeaponDetails[4, "capacity"] = 10;
$WeaponDetails[4, "damage"] = 70 / 100;
$WeaponDetails[4, "accuracy"] = 60 / 100;
$WeaponDetails[4, "fireRate"] = 60 / 100;
$WeaponDetails[4, "reloadSpeed"] = 30 / 100;
$WeaponDetails[4, "guiInfo"] = "Armory_SwarmerImage\tSwarmerButton";

$WeaponDetails[5, "name"] = "Ender Rocket Launcher";
$WeaponDetails[5, "lock"] = "Complete 'Swarmer Apprentice' and 'Chain Reaction' to Unlock.";
$WeaponDetails[5, "descript"] = "The Ender is even more prefered over it's counterpart, the Swarmer, and can be found in surprisingly larger amounts for a rocket launcher. Taking advantage of a spring loaded chasis, the Ender is capable of using less costly rockets to deal the same punishing missile strike to the destined undead victim.";
$WeaponDetails[5, "clipSize"] = 1;
$WeaponDetails[5, "capacity"] = 8;
$WeaponDetails[5, "damage"] = 90 / 100;
$WeaponDetails[5, "accuracy"] = 80 / 100;
$WeaponDetails[5, "fireRate"] = 100 / 100;
$WeaponDetails[5, "reloadSpeed"] = 40 / 100;
$WeaponDetails[5, "guiInfo"] = "Armory_RocketLauncherImage\tRocketLauncherButton";

$WeaponDetails[6, "name"] = "Mamba Sniper Rifle";
$WeaponDetails[6, "lock"] = "Complete 'Lurker Mastery' to Unlock.";
$WeaponDetails[6, "descript"] = "The Mamba fits perfectly into the hands of many individuals who would rather stay as far away from the fight as possible. This single shot sniper rifle hits hard when it matters, yet the ability to reload this weapon comes with a hefty practice, and thus it takes longer than any other known weapon.";
$WeaponDetails[6, "clipSize"] = 5;
$WeaponDetails[6, "capacity"] = 10;
$WeaponDetails[6, "damage"] = 85 / 100;
$WeaponDetails[6, "accuracy"] = 90 / 100;
$WeaponDetails[6, "fireRate"] = 40 / 100;
$WeaponDetails[6, "reloadSpeed"] = 15 / 100;
$WeaponDetails[6, "guiInfo"] = "Armory_MambaImage\tMambaButton";

$WeaponDetails[7, "name"] = "Kral";
$WeaponDetails[7, "lock"] = "Complete 'Ryder Overlord' and 'Duke Overlord' to Unlock.";
$WeaponDetails[7, "descript"] = "Very few knew the secrets of the legendary Area 51, but rumor had it that when the zombie appocalypse began, it was the first location pillaged by pirate looters and survivalists. This mysterious plasma weapon was amongst it's collection, not much is known about this weapon except audiences claim to have see zombies disintegrated by it.";
$WeaponDetails[7, "clipSize"] = 8;
$WeaponDetails[7, "capacity"] = 10;
$WeaponDetails[7, "damage"] = 45 / 100;
$WeaponDetails[7, "accuracy"] = 60 / 100;
$WeaponDetails[7, "fireRate"] = 75 / 100;
$WeaponDetails[7, "reloadSpeed"] = 55 / 100;
$WeaponDetails[7, "guiInfo"] = "Armory_KralImage\tKralButton";

$WeaponDetails[8, "name"] = "Kraad";
$WeaponDetails[8, "lock"] = "Complete 'Lurker Overlord' and 'Mamba Overlord' to Unlock.";
$WeaponDetails[8, "descript"] = "On the days leading up to the initial rising, scientists claimed to have discovered plasma weapon technology many years ago, and that it would be necessary in the coming days. How the scientific tides of this mysterious plasma assault rifle came to be of much need once the hoards began to charge.";
$WeaponDetails[8, "clipSize"] = 25;
$WeaponDetails[8, "capacity"] = 8;
$WeaponDetails[8, "damage"] = 30 / 100;
$WeaponDetails[8, "accuracy"] = 55 / 100;
$WeaponDetails[8, "fireRate"] = 75 / 100;
$WeaponDetails[8, "reloadSpeed"] = 60 / 100;
$WeaponDetails[8, "guiInfo"] = "Armory_KraadImage\tKraadButton";

$WeaponDetails[9, "name"] = "Kralmok";
$WeaponDetails[9, "lock"] = "Complete 'Disposition Overlord', 'Swarmer Overlord', and 'Rocket Launcher Overlord' to Unlock.";
$WeaponDetails[9, "descript"] = "At the pinacle of weapon technology, lies the plasma cannon. The mythical Kralmok is a force that is not to be reaconed with, capable of obliterating enitre hoards of zombies with a single shot. Very few have ever seen this weapon before, in fact, so few that many believe that this weapon doesn't even exist.";
$WeaponDetails[9, "clipSize"] = 1;
$WeaponDetails[9, "capacity"] = 7;
$WeaponDetails[9, "damage"] = 95 / 100;
$WeaponDetails[9, "accuracy"] = 80 / 100;
$WeaponDetails[9, "fireRate"] = 100 / 100;
$WeaponDetails[9, "reloadSpeed"] = 35 / 100;
$WeaponDetails[9, "guiInfo"] = "Armory_KralmokImage\tKralmokButton";

$WeaponDetails[10, "name"] = "Tesla Forcer";
$WeaponDetails[10, "lock"] = "Reach Affinity Level 50 on all Non-DLC Weapons to Unlock.";
$WeaponDetails[10, "descript"] = "Something happened on the night of the zombie uprising, a persistant lightning storm was created. Nobody knows the origin of this thunderstorm, but it was rumored that at the site of the storm, all zombies that entered the region were decemated by the wrath of lightning, could this be the working of a mysterious weapon?";
$WeaponDetails[10, "clipSize"] = 1;
$WeaponDetails[10, "capacity"] = 3;
$WeaponDetails[10, "damage"] = 100 / 100;
$WeaponDetails[10, "accuracy"] = 80 / 100;
$WeaponDetails[10, "fireRate"] = 100 / 100;
$WeaponDetails[10, "reloadSpeed"] = 15 / 100;
$WeaponDetails[10, "guiInfo"] = "Armory_TeslaForcerImage\tTeslaForcerButton";
//
//Callbacks
function onUnlockGun(%weaponID) {
   %info = getWeaponInfo(%weaponID);
   
   addInformativePush("unlock", "art/gui/weaponHud/"@strReplace(getField(%info, 0), " ", "")@".png", strupr($WeaponDetails[%weaponID, "name"]));
}

function onLevelUpWeapon(%gunName, %level) {
   addInformativePush("levelup", "game/data/image/guiIcons/guns/affinityup_"@strlwr(strReplace(getField(%gunName, 0), " ", ""))@".png", "Affinity "@%level@" Achieved!");
   //update the affinity level challenges
   %WID = getWeaponID(%gunName);
   %cL = getLevelChallenges(%WID);
   for(%i = 0; %i < getFieldCount(%cL); %i++) {
      if(!challengeComplete(%WID, getField(%cL, %i))) {
         %challenge = getChallenge(%WID, getField(%cL, %i));
         %progress = getField(%challenge, 2);
         %current = getSubStr(%progress, 0, strPos(%progress, "/"));
         %left = getSubStr(%progress, strPos(%progress, "/")+1, strLen(%progress));
         updateChallengeProgress(%WID, getField(%cL, %i), %level @"/"@ %left);
         if(%level >= %left) {
            //done!
            completeChallenge(%WID, getField(%cL, %i));
         }
      }
   }
}

function onChallengeCompleted(%treeIndex, %challengeIndex, %reward) {
   echo("Challenge Complete");
   %challenge = getChallenge(%treeIndex, %challengeIndex);
   %name = getField(%challenge, 0);
   
   processReward(%treeIndex, %reward);
   addInformativePush("challengecomplete", "game/data/image/guiIcons/guns/challenge_done.png", %name);
   
   //post challenge complete weapon unlock checks:
   if(%treeIndex == 0 && %challengeIndex == 18) {
      //Duke: Ryder Apprentice
      unlockWeapon(1);
      if(challengeComplete(2, 18)) {
         //Disposition: Ryder Apprentice & Lurker Apprentice
         unlockWeapon(3);
      }
   }
   
   if(%treeIndex == 0 && %challengeIndex == 0) {
      //Lurker: Ryder Marksman I
      unlockWeapon(2);
   }
   
   if(%treeIndex == 2 && %challengeIndex == 18) {
      if(challengeComplete(0, 18)) {
         //Disposition: Ryder Apprentice & Lurker Apprentice
         unlockWeapon(3);
      }
   }
   
   if(%treeIndex == 3 && %challengeIndex == 23) {
      //Swarmer: Disposition Mastery
      unlockWeapon(4);
   }
   
   if(%treeIndex == 4 && %challengeIndex == 7) {
      if(challengeComplete(4, 18)) {
         //Rocket Launcher: Swarmer Apprentice & Chain Reaction (Swarmer)
         unlockWeapon(5);
      }
   }
   if(%treeIndex == 4 && %challengeIndex == 18) {
      if(challengeComplete(4, 7)) {
         //Rocket Launcher: Swarmer Apprentice & Chain Reaction (Swarmer)
         unlockWeapon(5);
      }
   }
   
   if(%treeIndex == 2 && %challengeIndex == 20) {
      //Mamba: Lurker Mastery
      unlockWeapon(6);
   }
   
   //ultimate weapons
   //Kral: Ryder & Duke Overlord
   if(challengeComplete(0, 21) && challengeComplete(1, 23)) {
      unlockWeapon(7);
   }
   
   //Kraad: Lurker & Mamba Overlord
   if(challengeComplete(2, 21) && challengeComplete(6, 26)) {
      unlockWeapon(8);
   }
   
   //Kralmok: Disposition, Swarmer, and Rocket Launcher Overlord
   if(challengeComplete(3, 24) && challengeComplete(4, 21) && challengeComplete(5, 20)) {
      unlockWeapon(9);
   }
   
   //Tesla Forcer: Overlord Challenges on all other guns
   if(challengeComplete(0, 21) && challengeComplete(1, 23) && challengeComplete(2, 21) && challengeComplete(3, 24)
   && challengeComplete(4, 21) && challengeComplete(5, 20) && challengeComplete(6, 26) && challengeComplete(7, 22)
   && challengeComplete(8, 18) && challengeComplete(9, 19)) {
      unlockWeapon(10);
   }
}

//Armory GUI
function Armory_Out::onWake(%this) {
   ArmoryOut_Select("Ryder");
   ChallengeList.setSelectedRow(0);
   ChallengeList.onSelect(0);
   //check the status of the other guns
   for(%id = 1; $WeaponDetails[%id, "name"] !$= ""; %id++) {
      %guiInfo = $WeaponDetails[%id, "guiInfo"];
      %name = $WeaponDetails[%id, "name"];
		%lock = $WeaponDetails[%id, "lock"];
      if(weaponUnlocked(%id)) {
         nameToID(getWord(%guiInfo, 0)).tooltip = %name;
         nameToID(getWord(%guiInfo, 1)).tooltip = %name;
         //clear modulation
         nameToID(getWord(%guiInfo, 0)).deleteImageColor();
      }
		else {
         nameToID(getWord(%guiInfo, 0)).tooltip = %lock;
         nameToID(getWord(%guiInfo, 1)).tooltip = %lock;		
			nameToID(getWord(%guiInfo, 0)).setImageColor(2, 2, 2, 70);
		}
   }
   
}

function ArmoryOut_Select(%gunName) {
   //get the name in ID form
   %id = getWeaponID(%gunName);
   //Can we use this gun?
   if(!weaponUnlocked(%id)) {
      MessageBoxOK("Locked", "This weapons is currently locked.");
      return;
   }
   //Get my saved weapon info
   %info = getWeaponInfo(%id); //outputs: name\tspec\texp\tneededEXP\tlevel\tkills\theadshots
   %spec = getField(%info, 1);
   %exp = getField(%info, 2);
   %nEXP = getField(%info, 3);
   %level = getField(%info, 4);
   %kills = getField(%info, 5);
   %hs = getField(%info, 6);

	if(%spec $= "none") {
	   GunActiveSpec.setText("<Font:Arial:16>No Specialization Selected");
	}
	else { 
	   GunActiveSpec.setText("<Font:Arial:16>Active: "@getField($Upgrade[%spec], 0)@"");
	}
   
   NextAffinityMeter.setValue(%exp/%nEXP);
   AffinityMeter_Text.setText("<Just:Center>Affinity Progress<Just:Right>"@%exp@"/"@%nEXP);
   SelGunImage.setBitmap("art/gui/weaponHud/"@strReplace(getField(%info, 0), " ", "")@".png");
   GunKillCount.setText("<Font:Arial:16>Kills: "@%kills);
   GunHeadshotCount.setText("<Just:Right><Font:Arial:16>Headshots: "@%hs);
   if(%level == 50) {
      NextAffinity_Text.setText("<Just:Right>Max");
   }
   else {
      NextAffinity_Text.setText("<Just:Right>"@%level + 1);
   }

   //Set the GUI fields
   Selected_Name.setText("<Just:Center><Font:Arial:20>"@$WeaponDetails[%id, "name"]);
   GunDescription.setText("<Font:Arial:16>"@$WeaponDetails[%id, "descript"]);
   GunInfo_ClipSize.setText("<Font:Arial:16>Clip Size: "@$WeaponDetails[%id, "clipSize"]);
   GunInfo_CarryCapacity.setText("<Font:Arial:16>Capacity "@$WeaponDetails[%id, "capacity"]@" Clips");
   GunDmgMeter.setValue($WeaponDetails[%id, "damage"]);
   GunAccMeter.setValue($WeaponDetails[%id, "accuracy"]);
   GunFRMeter.setValue($WeaponDetails[%id, "fireRate"]);
   GunRTMeter.setValue($WeaponDetails[%id, "reloadSpeed"]);

	//Set Up Specializations
	specializations_OnSelectArmoryWeapon(%id);
   
   //Challenges
   ChallengeList.clear();
   %index = 0;
   while(getChallenge(%id, %index) !$= "ERROR") {
      %challengeDetails = getChallenge(%id, %index);
      $Challenges[%id, %index] = %challengeDetails;
      
      %c_name = getField(%challengeDetails, 0);
      
      ChallengeList.addRow(%index, %c_name);
      
      %index++;
   }
   
   ChallengeList.setSelectedRow(0);
   //update challenge
   %cDet = $Challenges[%id, 0];

   %c_name = getField(%cDet, 0);
   %c_desc = getField(%cDet, 1);
   %c_goal = getField(%cDet, 2);
   %c_rewd = getField(%cDet, 3);

   SelectedChallenge.setText("<Font:Arial:18><Just:Center>"@%c_name);
   ChallengeDescription.setText("<Font:Arial:16>"@%c_desc);

   if(challengeComplete(%id, 0)) {
      ChallengeReward.setText("<Font:Arial:16>Challenge Completed, "@%c_rewd@" Awarded.");
   }
   else {
      ChallengeReward.setText("<Font:Arial:16>"@%c_rewd);
   }

   %c_cur = getSubStr(%c_goal, 0, strPos(%c_goal, "/"));
   %c_fin = getSubStr(%c_goal, strPos(%c_goal, "/")+1, strLen(%c_goal));

   ChallengeProgress.setValue(%c_cur / %c_fin);
   ChallengeProgressText.setText("<Just:Center>Progress: "@%c_goal);
   //
   
   $SelectedGun = %id;
}
//

function ChallengeList::onSelect(%id, %text) {
   %gun = $SelectedGun;
   %cDet = $Challenges[%gun, %text];
   
   %c_name = getField(%cDet, 0);
   %c_desc = getField(%cDet, 1);
   %c_goal = getField(%cDet, 2);
   %c_rewd = getField(%cDet, 3);
   
   SelectedChallenge.setText("<Font:Arial:18><Just:Center>"@%c_name);
   ChallengeDescription.setText("<Font:Arial:16>"@%c_desc);
   
   if(challengeComplete(%gun, %text)) {
      ChallengeReward.setText("<Font:Arial:16>Challenge Completed, "@%c_rewd@" Awarded.");
   }
   else {
      ChallengeReward.setText("<Font:Arial:16>"@%c_rewd);
   }
   
   %c_cur = getSubStr(%c_goal, 0, strPos(%c_goal, "/"));
   %c_fin = getSubStr(%c_goal, strPos(%c_goal, "/")+1, strLen(%c_goal));
   
   ChallengeProgress.setValue(%c_cur / %c_fin);
   ChallengeProgressText.setText("<Just:Center>Progress: "@%c_goal);
}

function clientStartup() {
   //pull the GUID
   %guid = $ConnStore::guid;
   %file = GetUserDataPath() @"save/"@%guid@"/data.xmle";
   if(!isFile(%file)) {
      echo("* Creating Client Save File Now.");
      SaveClientData(%guid, %file);
   }
   else {
      echo("* Loading Client Save Data.");
      LoadClientData(%file);
   }
}

function clientCmdinformNextWave(%wave) {
	// Update the HUD
	WaveIndicator.setText("<Color:FFFFFF><Font:Arial:18><Just:Center>Wave "@%wave@"");
   // Display next wave GUI
   canvas.pushDialog(waveNumberGui);
   waveNumberText.setText("<Font:Arial:20><Color:FFFFFF>WAVE "@%wave@" START!");
   canvas.schedule(2500, popDialog, waveNumberGui);
}

function clientCmdaddZombieKill(%weapon, %type) {
   %WID = getWeaponID(%weapon);
   addWeaponKill(%WID);
   switch$(%type) {
      case "full":
         addWeaponExperience(%WID, 10);
      default:
         addWeaponExperience(%WID, 5);
   }
   //update the weapon "Marksman" Challenge
   %cL = getMarksmanChallenges(%WID);
   for(%i = 0; %i < getFieldCount(%cL); %i++) {
      if(!challengeComplete(%WID, getField(%cL, %i))) {
         %challenge = getChallenge(%WID, getField(%cL, %i));
         %progress = getField(%challenge, 2);
         %current = getSubStr(%progress, 0, strPos(%progress, "/"));
         %left = getSubStr(%progress, strPos(%progress, "/")+1, strLen(%progress));
         updateChallengeProgress(%WID, getField(%cL, %i), %current+1 @"/"@ %left);
         if(%current+1 >= %left) {
            //done!
            completeChallenge(%WID, getField(%cL, %i));
         }
      }
   }
}

function clientCmdaddZombieHeadshot(%weapon) {
   %WID = getWeaponID(%weapon);
   addWeaponHeadshot(%WID);
   addWeaponExperience(%WID, 5);
   //update the weapon "Sharpshooter" Challenge
   %cL = getSharpshooterChallenges(%WID);
   for(%i = 0; %i < getFieldCount(%cL); %i++) {
      if(!challengeComplete(%WID, getField(%cL, %i))) {
         %challenge = getChallenge(%WID, getField(%cL, %i));
         %progress = getField(%challenge, 2);
         %current = getSubStr(%progress, 0, strPos(%progress, "/"));
         %left = getSubStr(%progress, strPos(%progress, "/")+1, strLen(%progress));
         updateChallengeProgress(%WID, getField(%cL, %i), %current+1 @"/"@ %left);
         if(%current+1 >= %left) {
            //done!
            completeChallenge(%WID, getField(%cL, %i));
         }
      }
   }
}

function clientCmdSaveFromServer() {
   %guid = $ConnStore::guid;
   %file = GetUserDataPath() @"save/"@%guid@"/data.xmle";
   SaveClientData(%guid, %file);
}

//ARMORY GUI - IN GAME
function clientCmdupdateClientPoints(%points) {
   $LocalPoints = %points;
	//update points GUI
	PointsIndicator.setText("<Font:Arial:16><Color:FFFFFF>Points:<Just:Right><Color:009900>"@%points@"");
}

function clientCmdUpdateZCounter(%left) {
   ZombiesIndicator.setText("<Font:Arial:16><Color:FFFFFF>Remaining Zombies:<Just:Right><Color:990000>"@%left@"");
}

function clientCmdOpenArmory() {
   Canvas.pushDialog(Armory_IN);
}

function clientCmdPushInfo(%primary, %secondary, %pInfo, %sInfo) {
   echo(%primary SPC %secondary);

   PrimaryInfo.setText(%pInfo);
	SecondaryInfo.setText(%sInfo);
	Primary_Weapon.setBitmap($WHTag_Gun @ %primary);
	Secondary_Weapon.setBitmap($WHTag_Gun @ %secondary);

	if(%secondary $= "") {
	   Secondary_Weapon.setVisible(false);
		BuyAmmoSec.setVisible(false);
		SecondaryInfo.setVisible(false);
	}
	else {
	   Secondary_Weapon.setVisible(true);
		BuyAmmoSec.setVisible(true);
		SecondaryInfo.setVisible(true);	
	}
}

function Armory_In::onWake(%this) {
   //set points
   my_points.setText("<Font:Arial:20><Color:FFFFFF>Points: "@$LocalPoints);

	//specializations: hide all unless needed
	armory_spec_ryder.setVisible(false);
	armory_spec_duke.setVisible(false);
	armory_spec_lurker.setVisible(false);
	armory_spec_disposition.setVisible(false);
	armory_spec_swarmer.setVisible(false);
   armory_spec_rocketlauncher.setVisible(false);
	armory_spec_mamba.setVisible(false);
	armory_spec_kral.setVisible(false);
	armory_spec_kraad.setVisible(false);
	armory_spec_kralmok.setVisible(false);
	armory_spec_teslaforcer.setVisible(false);

	//what is unlocked?
	if(!weaponUnlocked(0)) {
	   //well... you have some problems sir... lol
		//do nothing
	}
	//---------------------
	if(!weaponUnlocked(1)) {
	   armoryimage_duke.setVisible(false);
		armory_buy_duke.setVisible(false);
	}
	else {
	   armoryimage_duke.setVisible(true);
		armory_buy_duke.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(2)) {
	   armoryimage_lurker.setVisible(false);
		armory_buy_lurker.setVisible(false);
	}
	else {
	   armoryimage_lurker.setVisible(true);
		armory_buy_lurker.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(3)) {
	   armoryimage_disposition.setVisible(false);
		armory_buy_disposition.setVisible(false);
	}
	else {
	   armoryimage_disposition.setVisible(true);
		armory_buy_disposition.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(4)) {
	   armoryimage_swarmer.setVisible(false);
		armory_buy_swarmer.setVisible(false);
	}
	else {
	   armoryimage_swarmer.setVisible(true);
		armory_buy_swarmer.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(5)) {
	   armoryimage_rocketlauncher.setVisible(false);
		armory_buy_rocketlauncher.setVisible(false);
	}
	else {
	   armoryimage_rocketlauncher.setVisible(true);
		armory_buy_rocketlauncher.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(6)) {
	   armoryimage_mamba.setVisible(false);
		armory_buy_mamba.setVisible(false);
	}
	else {
	   armoryimage_mamba.setVisible(true);
		armory_buy_mamba.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(7)) {
	   armoryimage_kral.setVisible(false);
		armory_buy_kral.setVisible(false);
	}
	else {
	   armoryimage_kral.setVisible(true);
		armory_buy_kral.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(8)) {
	   armoryimage_kraad.setVisible(false);
		armory_buy_kraad.setVisible(false);
	}
	else {
	   armoryimage_kraad.setVisible(true);
		armory_buy_kraad.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(9)) {
	   armoryimage_kralmok.setVisible(false);
		armory_buy_kralmok.setVisible(false);
	}
	else {
	   armoryimage_kralmok.setVisible(true);
		armory_buy_kralmok.setVisible(true);
	}
	//---------------------
	if(!weaponUnlocked(10)) {
	   armoryimage_teslaforcer.setVisible(false);
		armory_buy_teslaforcer.setVisible(false);
	}
	else {
	   armoryimage_teslaforcer.setVisible(true);
		armory_buy_teslaforcer.setVisible(true);
	}
	//---------------------
	//HT weapons?
	HTWeaponText.setVisible(true);
	if(!weaponUnlocked(7) && !weaponUnlocked(8) && !weaponUnlocked(9) && !weaponUnlocked(10)) {
		//magical weapons will remain hidden for now ;)
	   HTWeaponText.setVisible(false);
	}
}

function armory_buy(%item) {
   commandToServer('BuyItem', %item);
}

function clientCmdReturnArmory(%code) {
	if(%code == 0) {
	   Canvas.popDialog(Armory_IN);
	}
	else {
		Canvas.popDialog(Armory_IN);
      MessageBoxOK("Insufficient Points", "You do not have enough points to buy this item.");
	}
}

function getClientRank() {
   %totalRank = 0;
	//Rank #: # of Guns Unlocked + # of Guns at Level 50
	for(%i = 0; %i < 11; %i++) {
		if(weaponUnlocked(%i)) {
		   %totalRank++;
		}
		//get the weapon rank #
      %info = getWeaponInfo(%id); 
      %level = getField(%info, 4);
		if(%level == 50) {
		   %totalRank++;
		}
	}

	return %totalRank;
}

function clientCmdRequestClientRank() {
   pushClientRank();
}

function pushClientRank() {
   %totalRank = getClientRank();

	commandToServer('PushClientRank', %totalRank);
}

function getLevelInfo( %missionFile ) {
   %file = new FileObject();
   
   %LevelInfoObject = "";
   
   if ( %file.openForRead( %missionFile ) ) {
		%inInfoBlock = false;
		
		while ( !%file.isEOF() ) {
			%line = %file.readLine();
			%line = trim( %line );
			
			if( %line $= "new ScriptObject(LevelInfo) {" ) {
				%inInfoBlock = true;
				%newLine = "new ScriptObject() {";
			}
			else if( %line $= "new LevelInfo(theLevelInfo) {" ) {
				%inInfoBlock = true;
			   %newLine = "new LevelInfo() {";
			}
			else if( %inInfoBlock && %line $= "};" ) {
				%inInfoBlock = false;
				%LevelInfoObject = %LevelInfoObject @ %line; 
				break;
			}
			
			if( %inInfoBlock ) {
				if(%newLine !$= "") {
				   %LevelInfoObject = %LevelInfoObject @ %newLine @ " "; 
				}
				else {
				   %LevelInfoObject = %LevelInfoObject @ %line @ " "; 
				}			   
			}
			%newLine = "";
		}
		
		%file.close();
	}
   %file.delete();

	if( %LevelInfoObject !$= "" ) {
	   %LevelInfoObject = "%LevelInfoObject = " @ %LevelInfoObject;
	   eval( %LevelInfoObject );

      return %LevelInfoObject;
	}
	
	// Didn't find our LevelInfo
   return 0; 
}

function clientCmdEndTutorial() {
   schedule(5000, 0, disconnect);
}

function clientCmdsafeDisconnect() {
   schedule(500, 0, disconnect);
}

//Armory_In
function clientCmdarmorySpecs(%list) {
	for(%i = 0; %i < getFieldCount(%list); %i++) {
	   %inSpec[%i] = getField(%list, %i);
		if(%inSpec[%i] $= "none") {
		   $InArmory[%i].setVisible(false);
		}
		else {
			$InArmory[%i].setVisible(true);
			if(strstr(%inSpec[%i], "Mastery") != -1) {
				%info = getWeaponInfo(%i); 
				%gun = strlwr(strReplace(getField(%info, 0), " ", ""));
				%insert = strReplace(getField($Upgrade[11], 2), "_x", "_"@%gun@"");
			   $InArmory[%i].setBitmap("game/data/image/guiIcons/guns/"@%insert@"");   
			}
			for(%j = 0; $Upgrade[%j] $= ""; %j++) {
				if(getField($Upgrade[%j], 0) $= %inSpec[%i]) {		   
				   $InArmory[%i].setBitmap("game/data/image/guiIcons/guns/"@getField($Upgrade[%j], 2)@"");
				}
			}
		}
	}
}










//CLIENTCMD AWARD CHALLENGE COMMANDS
function clientCmdaddIncineration(%weaponID) {
	switch(%weaponID) {
		case 0:
         %challenge = getChallenge(0, 15);
         if(!challengeComplete(0, 15)) { 
	         %prog = getField(%challenge, 2);
		      %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		      %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		      if(%current + 1 >= %goal) {
		         completeChallenge(0, 15);
	      	}
            //set challenge progress
            updateChallengeProgress(0, 15, %current + 1@"/"@%goal);
         }

		case 2:
         %dC[0] = getChallenge(2, 13);
	      %dC[1] = getChallenge(2, 14);
	      %dC[2] = getChallenge(2, 15);
			%dC[3] = getChallenge(2, 16);
			%dC[4] = getChallenge(2, 17);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(2, 13+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(2, 13+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(2, 13+%i, %current+1@"/"@%goal);
		      }
	      }

		case 3:
         %dC[0] = getChallenge(3, 16);
	      %dC[1] = getChallenge(3, 17);
	      %dC[2] = getChallenge(3, 18);
			%dC[3] = getChallenge(3, 19);
			%dC[4] = getChallenge(3, 20);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(3, 16+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(3, 16+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(3, 16+%i, %current+1@"/"@%goal);
		      }
	      }

		case 4:
         %dC[0] = getChallenge(4, 8);
	      %dC[1] = getChallenge(4, 9);
	      %dC[2] = getChallenge(4, 10);
			%dC[3] = getChallenge(4, 11);
			%dC[4] = getChallenge(4, 12);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(4, 8+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(4, 8+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(4, 8+%i, %current+1@"/"@%goal);
		      }
	      }

		case 6:
         %dC[0] = getChallenge(6, 13);
	      %dC[1] = getChallenge(6, 14);
	      %dC[2] = getChallenge(6, 15);
			%dC[3] = getChallenge(6, 16);
			%dC[4] = getChallenge(6, 17);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(6, 13+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(6, 13+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(6, 13+%i, %current+1@"/"@%goal);
		      }
	      }
	}
}

function clientCmdaddDisintegration(%weaponID) {
	switch(%weaponID) {
		case 0:
         %challenge = getChallenge(0, 16);
         if(!challengeComplete(0, 16)) { 
	         %prog = getField(%challenge, 2);
		      %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		      %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		      if(%current + 1 >= %goal) {
		         completeChallenge(0, 16);
	      	}
            //set challenge progress
            updateChallengeProgress(0, 16, %current + 1@"/"@%goal);
         }

		case 1:
         %challenge = getChallenge(1, 19);
         if(!challengeComplete(1, 19)) { 
	         %prog = getField(%challenge, 2);
		      %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		      %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		      if(%current + 1 >= %goal) {
		         completeChallenge(1, 19);
	      	}
            //set challenge progress
            updateChallengeProgress(1, 19, %current + 1@"/"@%goal);
         }

		case 6:
         %dC[0] = getChallenge(6, 18);
	      %dC[1] = getChallenge(6, 19);
	      %dC[2] = getChallenge(6, 20);
			%dC[3] = getChallenge(6, 21);
			%dC[4] = getChallenge(6, 22);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(6, 18+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(6, 18+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(6, 18+%i, %current+1@"/"@%goal);
		      }
	      }
	}
}

function clientCmdaddShockwave(%weaponID) {
	switch(%weaponID) {
		case 1:
         %challenge = getChallenge(1, 18);
         if(!challengeComplete(1, 18)) { 
	         %prog = getField(%challenge, 2);
		      %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		      %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		      if(%current + 1 >= %goal) {
		         completeChallenge(1, 18);
	      	}
            //set challenge progress
            updateChallengeProgress(1, 18, %current + 1@"/"@%goal);
         }

		case 4:
         %dC[0] = getChallenge(4, 13);
	      %dC[1] = getChallenge(4, 14);
	      %dC[2] = getChallenge(4, 15);
			%dC[3] = getChallenge(4, 16);
			%dC[4] = getChallenge(4, 17);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(4, 13+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(4, 13+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(4, 13+%i, %current+1@"/"@%goal);
		      }
	      }

		case 5:
         %dC[0] = getChallenge(5, 7);
	      %dC[1] = getChallenge(5, 8);
	      %dC[2] = getChallenge(5, 9);
			%dC[3] = getChallenge(5, 10);
			%dC[4] = getChallenge(5, 11);

	      for(%i = 0; %i < 5; %i++) {
		      if(!challengeComplete(5, 7+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(5, 7+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(5, 7+%i, %current+1@"/"@%goal);
		      }
	      }

		case 7:
         %dC[0] = getChallenge(7, 15);
	      %dC[1] = getChallenge(7, 16);
	      %dC[2] = getChallenge(7, 17);
			%dC[3] = getChallenge(7, 18);

	      for(%i = 0; %i < 4; %i++) {
		      if(!challengeComplete(7, 15+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(7, 15+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(7, 15+%i, %current+1@"/"@%goal);
		      }
	      }

		case 9:
         %dC[0] = getChallenge(9, 9);
	      %dC[1] = getChallenge(9, 10);
	      %dC[2] = getChallenge(9, 11);
			%dC[3] = getChallenge(9, 12);
			%dC[4] = getChallenge(9, 13);
			%dC[5] = getChallenge(9, 14);

	      for(%i = 0; %i < 6; %i++) {
		      if(!challengeComplete(9, 9+%i)) { 
	            %prog = getField(%dC[%i], 2);
		         %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		         %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		         if(%current+1 >= %goal) {
		            completeChallenge(9, 9+%i);
		         }     
			      //set challenge progress
               updateChallengeProgress(9, 9+%i, %current+1@"/"@%goal);
		      }
	      }
	}
}

function clientCmdaddMiniNuke() {
   %dC[0] = getChallenge(5, 12);
   %dC[1] = getChallenge(5, 13);
	%dC[2] = getChallenge(5, 14);
	%dC[3] = getChallenge(5, 15);
	%dC[4] = getChallenge(5, 16);

	for(%i = 0; %i < 5; %i++) {
		if(!challengeComplete(5, 12+%i)) { 
	      %prog = getField(%dC[%i], 2);
		   %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		   %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		   if(%current+1 >= %goal) {
		      completeChallenge(5, 12+%i);
		   }     
			//set challenge progress
         updateChallengeProgress(5, 12+%i, %current+1@"/"@%goal);
		}
	}
}

function clientCmdaddRyderMedic(%amount) {
   %challenge = getChallenge(0, 17);
   if(!challengeComplete(0, 17)) { 
	   %prog = getField(%challenge, 2);
		%current = getSubStr(%prog, 0, strPos(%prog, "/"));
		%goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		if(%current + %amount >= %goal) {
		   completeChallenge(0, 17);
		}
      //set challenge progress
      updateChallengeProgress(0, 17, %current + %amount@"/"@%goal);
   }
}

function clientCmdaddDispositionMultiKill() {
   %dC[0] = getChallenge(3, 13);
	%dC[1] = getChallenge(3, 14);
	%dC[2] = getChallenge(3, 15);

	for(%i = 0; %i < 3; %i++) {
		if(!challengeComplete(3, 13+%i)) { 
	      %prog = getField(%dC[%i], 2);
		   %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		   %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		   if(%current+1 >= %goal) {
		      completeChallenge(3, 13+%i);
		   }
			//set challenge progress
         updateChallengeProgress(3, 13+%i, %current+1@"/"@%goal);
		}
	}
}

function clientCmdaddSwarmerChainReaction() {
	if(!challengeComplete(4, 7)) {
	   completeChallenge(4, 7);
		updateChallengeProgress(4, 7, 1@"/"@1);
	}
}

function clientCmdaddKralmokSeven() {
	if(!challengeComplete(9, 15)) {
	   completeChallenge(9, 15);
		updateChallengeProgress(9, 15, 1@"/"@1);	
	}
}

function clientCmdaddDukeBlast() {
   %dC[0] = getChallenge(1, 13);
	%dC[1] = getChallenge(1, 14);
	%dC[2] = getChallenge(1, 15);
	%dC[3] = getChallenge(1, 16);
	%dC[4] = getChallenge(1, 17);

	for(%i = 0; %i < 5; %i++) {
		if(!challengeComplete(1, 13+%i)) { 
	      %prog = getField(%dC[%i], 2);
		   %current = getSubStr(%prog, 0, strPos(%prog, "/"));
		   %goal = getSubStr(%prog, strPos(%prog, "/")+1, strLen(%prog));
		   if(%current+1 >= %goal) {
		      completeChallenge(1, 13+%i);
		   }
			//set challenge progress
         updateChallengeProgress(1, 13+%i, %current+1@"/"@%goal);
		}
	}
}